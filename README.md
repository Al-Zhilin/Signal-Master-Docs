> [!NOTE]
> Это документация на проект, который по обьективным причинам пока не может быть выложен в общий доступ. Но для некоторых целей нашей команде понадобилось сделать документацию к нему открытой

# *Signal-Master*
## *Программное обеспечение для управления генератором сигналов и осциллографом*

## *Оглавление:*
-  [Подготовительный этап:](#подготовительный-этап)
    - [Введение:](#введение)
    - [Изучение существующих аналогов:](#изучение-существующих-аналогов)
    - [Определение задач проекта:](#определение-задач-проекта)
    - [Определение целевых устройств использования программы](#определение-целевых-устройств-использования-программы)
    - [Выбор инструментов реализации:](#выбор-инструментов-реализации)
    - [Требования к проекту на разных этапах реализации (Roadmap продукта):](#требования-к-проекту-на-разных-этапах-реализации-roadmap-продукта)
    
-   [Этап разработки:](#этап-разработки)
    -   [Краткий обзор технических решений:](#краткий-обзор-технических-решений)
        - [Подключение генератора:](#для-генератора-это-реализовано-так)
        - [Подключение осциллографа:](#связь-с-осциллографом-в-программе-осуществляется-посредством-lan-интерфейса)
        - [Подсказки при вводе команды:](#подсказки-в-поле-ввода-команды-при-использовании-консоли-реализованы-с-помощью-qcompiler)
        - [Реализация консолей ввода:](#консоли-приборов-реализованы-с-помощью-виджетов-qtextedit-qlineedit-и-qpushbutton)

-   [Обзор проекта:](#обзор-проекта)
    - [Обзор визуальной части проекта:](#обзор-визуальной-части-проекта-и-навигации-между-окнами)
    - [Руководство по использованию:](#руководство-по-использованию)

-   [Разработчики](#разработчики)

## *Подготовительный этап:*
### *Введение:*
- Основной целью проекта является создание программного обеспечения (далее - <u>ПО</u>) для одновременного управления генератором сигналов и осциллографом.

### *Изучение существующих аналогов:*
- Предложенные на рынке готовые ПО имеют ряд технических и иных особенностей:
  - Узкая специализация на конкретной модели прибора
  - Отсутствие ПО, которое бы предлагало одновременное управление двумя приборами
  - Зачастую сложный интерфейс, не допускающий интуитивного управления, а так же не дублирующий внешнее визуальное представление реального прибора.

  Из этих пунктов явно выводится надобность разработки собственного продукта, упрощающего процесс привыкания к виртуальному управлению устройствами и сочетающего в себе универсальность применяемости программного кода к разным устройствам и множество поддерживаемых проборов от различных производителей.

### *Определение задач проекта:*
В качестве основных требований к проекту были выдвинуты следующие пункты:
- Создание **универсального ПО**, позволяющего организовывать управление разными моделями устройств измерения и генерации электрического сигнала
- Возможность управления в одной программе двумя приборами (генератор сигналов и осциллограф)
- Актуальность используемых ресурсов (написание на современных версиях библиотек и фреймворков)

### *Определение целевых устройств использования программы:*
- В своей основной версии программа ориентирована на персональные компьютеры или ноутбуки с операционной системой Windows 7 и выше, с разрядностью x64.

### *Выбор инструментов реализации:*
> [!TIP] 
> В 1990 году впервые был введен стандарт SCPI (Standard Commands for Programmable Instruments), который позволил стандартизировать принципы общения с измерительными приборами. Притерпев лишь небольшие изменения в процессе развития, он активно используется и в наши дни, сохраняя свою первоначальную общую концепцию. SCPI позволяет организовать общение с **любим измерительным прибором посредством универсальных команд**, что значительно упрощает разработку любого ПО в этой области. 


**Отсюда вытекает список инструментов, используемых в процессе реализации:**
- Основной язык программирования - `С++`
- Фреймворк, позволяющий создавать интерфейсные кроссплатформенные приложения на С++ - `Qt`
- `Ni-Visa` - реализация стандарта **VISA** (Virtual Instrument Software Architecture, или интерфейс ввода-вывода) для настройки и программирования тестовых систем.

### *Требования к проекту на разных этапах реализации (Roadmap продукта):*
Подобнно всем проектам, разрабатывающимся в ограниченное время, конечный набор всех возможностей нашего ПО на этапе планирования был разделен на части. Каждой части выведен срок, иными словами мы составили Roadmap нашего продукта:

1) **К моменту представления проекта публике и составу жюри:**
   - В качестве начальных моделей приборов, для которых на ранних этапах реализуется программа, были выбраны генератор UNI-T UTG932E и осциллограф Rigol DS1000Z
   - Разработаны реализации подлючения приборов к ПК с помощью нескольких поддерживаемых интерфейсов 
   - Создана и реализована интерфейсная часть функций подключения, пользователю в удобном формате представлен выбор варианта соединения, поиска доступных приборов и возможности соединения с конкретно выбранным устройством.
   - Для обоих приборов создан вариант консольного управления, т.е. возможность ручного ввода SCPI команд в соответствующее окно и просмотр ответа прибора
   - Разработаны и подготовллены к реализации виртуальные версии интерфейсов физических приборов

2) **Через 4 месяца после представления и одобрения со стороны жюри:**
   - Планируется реализовать интерфейсное управление приборами, на замену консольному, которое останеться для отладки и подключения еще не поддерживаемых приборов
   - Создание цикла текстовых и видеоматериалов, позволяющих аудитории вникнуть в суть предметной области, задачи проекта и особенности реализации
   - Глобальная оптимизация кода, тестирвание и отладка нововведений

3) **8 месяцев работы над проектом после первичной оценки и сдачи принесут:**
    - Реализацию виртуальных дисплеев (экранов/мониторов) приборов, дублирующих физические
    - Создание базы данных приборов, включающую в себя особенности и набор SCPI команд конкретных моделей приборов (могут незначительно отличаться у каждого производителя)
    - Расширение списка поддерживаемых устройств, что позволит, извлекая данные из базы, управлять интерфейсно большим количеством устройств

## *Этап разработки:*
### *Краткий обзор технических решений:*
-   Подключение приборов требует от пользователя выбора интерфейса соединения с прибором, либо указания к поиску устройств на всех каналах. Это реализовано с помощью специальных SCPI команд следующим образом:   

#### **Для генератора это реализовано так:**

1) Создания enumeration для различных видов связи:
```
enum ConnectionType {
    UNDEFINED,
    USB,
    GPIB,
    COM,
    Ethernet,
    All
};
ConnectionType connection = UNDEFINED;
```

2) Обработки изменения состояний группы из RadioButton, указывающей на выбор пользователя:

```
void GeneralWindow::on_usb_radial_6_clicked()       //Выбрать USB
{
    connection = USB;
}


void GeneralWindow::on_gpib_radial_6_clicked()      //Выбрать GPIB
{
    connection = GPIB;
}


void GeneralWindow::on_com_radial_6_clicked()       //Выбрать COM
{
    connection = COM;
}


void GeneralWindow::on_ethernet_6_radial_clicked()      //Выбрать Ethernet
{
    connection - Ethernet;
}

void GeneralWindow::on_radioButton_clicked()           //все типы подключения
{
    connection = All;
}
```

3) Создания Visa-маски, содержащей соответствующую выбору пользователя команду:

```
switch (connection) {
    case USB:     visaMask = "USB?*INSTR"; break;
    case GPIB:    visaMask = "GPIB?*INSTR"; break;
    case COM:     visaMask = "ASRL?*INSTR"; break;
    case Ethernet:visaMask = "TCPIP?*INSTR"; break;
    case All:     visaMask = "?*INSTR"; break;
    default:
        ui->deviceList->clear();
        ui->deviceList->addItem("Тип подключения не выбран.");
        return;
    }
```

4) А так же использования команды для поиска устройств на выбранном(-ых) интерфейсе(-ах):

```
status = viFindRsrc(defaultRM, visaMask.toStdString().c_str(), &findList, &numInstrs, instrDescriptor);
```
5) После обработки успешности посика и найденных устройств список доступных выводиться в  `ui->deviceList (QListWidget)`

#### **Связь с осциллографом в программе осуществляется посредством LAN интерфейса:**

1) IP-адрес прибора вводиться в `QLineEdit` с именем `lineEdit`:

```
QString ipAddress = ui->lineEdit->text().trimmed();

    if (ipAddress.isEmpty()) {
        emit signal_connectionStatus("Введите IP-адрес");
        return;
    }

    if (measuring->connectToVisa()) {
        measuring->slot_connectToRigol(ipAddress);
    } else {
        emit signal_connectionStatus("Ошибка инициализации VISA");
    }
```

2) Введенный адрес передается в функцию, которая осуществляет подключение к прибору:

```
void MyMeasuring::slot_connectToRigol(const QString& ip)
{
    QString resource = QString("TCPIP0::%1::INSTR").arg(ip);
    ViStatus status = viOpen(rm, resource.toUtf8().data(), VI_NULL, 2000, &rsrcRIGOL);

    if (status == VI_SUCCESS) {
        emit signal_connectionStatus("Подключение совершено!");

        char idn[256] = {};
        status = viQueryf(rsrcRIGOL, (ViString)"*IDN?\n", (ViString)"%t", idn);
        if (status == VI_SUCCESS) {
            qDebug() << "Oscilloscope ID:" << idn;
        }
    } else {
        emit signal_connectionStatus("Не удалось подключиться");
    }
}
```

#### **Подсказки в поле ввода команды при использовании консоли реализованы с помощью `QCompiler`:**

```
//Пример для поля ввода генератора (подсказки осциллографа реализованы идентично):

QCompleter* genCompleter = new QCompleter(generatorCommands, this);
    genCompleter->setCaseSensitivity(Qt::CaseInsensitive);
    genCompleter->setFilterMode(Qt::MatchContains);

    ui->GeneratorCommand->setCompleter(genCompleter);
```

#### **Консоли приборов реализованы с помощью виджетов `QTextEdit`, `QLineEdit` и `QPushButton`**:

Команды вводятся в `QLineEdit` пользователем, после нажатия `QPushButton` прибору отправляется введенная команда.

**В качестве примера рассмотрим реализацию для осциллографа:**

```
// С помощью условий:

if (command.endsWith("?"))
if (command.startsWith(":")) 

// Введенная команда проверяется на надобность получение ответа после ее отправки, а так же на простую валидность.
```
В зависимости от наличия "?" в конце команды, программа определяет, нужно ли получаеть ответ от прибора после отправки ему команды, или нет соответственно.

Функция, не предусматривающая ответа от устройства:

```
bool MyMeasuring::sendCommand(const QString &cmd)
{
    if (rsrcRIGOL == VI_NULL) {
        qDebug() << "Нет активного соединения с осциллографом.";
        return false;
    }
    // Передача команд осциллографу через VISA
    ViStatus status = viPrintf(rsrcRIGOL, (ViString)(cmd.toUtf8() + "\n").data()); // Функция из VISA API: передаёт SCPI-команду в прибор
    if (status != VI_SUCCESS) { // И как раз VISA-драйвер общается с осциллографом по USB, LAN, GPIB и т.д.
        qDebug() << "Ошибка отправки команды: " << cmd;
        return false;
    }
    return true;
}
```
И функция, предусматривающая получение и обработку ответа от прибора:

```
bool MyMeasuring::query(const QString &cmd, QString &response) {
    if (rsrcRIGOL == VI_NULL)
        return false;

    // Буфер для ответа
    char buffer[256] = {};

    // Отправляем команду и читаем ответ за один вызов
    ViStatus status = viQueryf(rsrcRIGOL, (ViString)"%s\n", (ViString)"%t", cmd.toUtf8().constData(), buffer);
    if (status != VI_SUCCESS)
        return false;

    response = QString::fromUtf8(buffer);
    return true;
}
```
Для генератора реализация консольного управления идентична и не требует подробного рассмотрения.

## *Обзор проекта:*
В этом разделе представлен обзор готовых на момент последнего редактирования статьи функция, а так же краткое руководство пользования ПО.

### *Обзор визуальной части проекта и навигации между окнами:*
При запуске программы пользователя встречает окно:

![image](https://github.com/user-attachments/assets/8276183f-9c8a-4675-b22b-724eb2655e61)

- **Кнопка `Связь`** открывает меню выбора, к какому из приборов сейчас нужно настроить подключение:
  
![image](https://github.com/user-attachments/assets/95e69079-36a1-4a3e-99b4-0220453f885c)

- Для осциллографа и генератора эти окна выглядят соответственно:

  - Осциллограф:
  
    ![image](https://github.com/user-attachments/assets/92c602a7-d631-4052-bb65-e9dadb6e9bf7)

  - Генератор:
  
    ![image](https://github.com/user-attachments/assets/51df5997-408e-4498-8618-73e5dffb0a48)
  
- **Кнопка `Сведения`** открывает кнопку "О программе", где собраны ссылки на руковоодство и другие полезные материалы:
  
![image](https://github.com/user-attachments/assets/fb1a1016-2ba1-49c3-afe7-5ca4bd5cccac)

- По кнопкам ниже можно открыть интерфейсы приборов:

![image](https://github.com/user-attachments/assets/d32a15c1-3a68-4e12-a567-3ccbbc64ae6d)

- Нижняя часть главного окна позволяет пользователю общааться с подключеннными приборами с помощью реализованной консоли:

![image](https://github.com/user-attachments/assets/aef8edc8-85ac-438a-b070-9371e9553260)

### *Руководство по использованию:*
#### *Алгоритм использования программы:*
1) Через кнопку `Связь` открываем панель для прибора, который хотим подключить:
   - Для генератора:

     ![gen](https://github.com/user-attachments/assets/969030bc-efda-4b47-84d2-f0c7b5ac35e7)

     1) Выбираем интерфейс связи (кнопки выделены красным цветом)
     2) Нажимаем кнопку `Поиск устройств` (выделена синим)
     3) В окне, выделенном зеленым, появяться доступные по выбранному интерфейсу связи приборы. Выбираем нужный нажатием кнопки `Подключить выбранной` (обведена оранжевым)
     4) Статус подключения высветиться во всплывающем окне, а при успешном соединении окно подключения автоматически свернется

    - Для осциллографа:

      ![image](https://github.com/user-attachments/assets/38b08a5d-7c1f-4343-9d8a-053b8fc15fcc)

      1) Вводим в соответствующее поле IP-адрес вашего устройства
      2) Нажимаем кнопку `Connect`
      3) Статус подключения отобразится в нижней части главного окна, при успешном соединении окно подключения осциллографа можно закрыть

2) После подключения нам доступно консольное управление приборами, с помощью ввода SCPI команд. Базовые из них уже введены в программу, поэтому отобразятся в подсказках, соответственнно началу пользовательского ввода в поле.
- Отправка команды на прибор:

     ![image](https://github.com/user-attachments/assets/4c4d707e-afee-4fab-9024-5beec73a2552)

  -    В поле ввода (выделены красным) соответствующего прибора вводим SCPI команду, доступную и корректную для исполнения на ввашем устройстве
  
> [!NOTE]
> Список и синтаксис SCPI команд может отличаться у разных производителей! Список доступных можно узнать на сайте производителя, выбрав конкретную модель прибора.
    
  -    После ввода команды нажимаем кнопку `Отправить` (выделены синим)
  -    Статус отправки отобразиться в поле, выделенном зеленым
  -    Если отправленная команда подразуменвает ответ от прибора, он так же появиться в этом поле


## *Разработчики:*
Над разработкой программного продукта работали студенты КубГУ Физико-Технического факультета, направления "Информационные системы и технологии" (ИСиТ):

- [*Валерия Яцук*](https://github.com/petrenko-vel)
- [*Алексей Жилин*](https://github.com/Al-Zhilin)
- [*Александр Скорняков*](https://github.com/VortexCodeRU)
- [*Никита Юрченко*](https://github.com/YuN1k1ta)
